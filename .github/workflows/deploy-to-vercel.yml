name: Deploy to Vercel

on:
  pull_request:
    types: [closed]
    paths:
      - 'projects/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  detect-changes:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.detect.outputs.projects }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed projects
        id: detect
        run: |
          # Get list of changed files in the PR
          changed_files=$(git diff --name-only HEAD~1 HEAD)

          # Extract unique project directories from changed files
          projects=$(echo "$changed_files" | \
            grep '^projects/' | \
            cut -d'/' -f2 | \
            sort -u | \
            jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "projects=$projects" >> $GITHUB_OUTPUT
          echo "Detected changed projects: $projects"

  deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.projects != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: ${{ fromJSON(needs.detect-changes.outputs.projects) }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Convert project name to secret format
        id: secret_name
        run: |
          # Replace hyphens with underscores and convert to uppercase for secret name
          SECRET_NAME=$(echo "${{ matrix.project }}" | tr '-' '_' | tr '[:lower:]' '[:upper:]')
          echo "name=VERCEL_PROJECT_ID_${SECRET_NAME}" >> $GITHUB_OUTPUT
          echo "Secret name: VERCEL_PROJECT_ID_${SECRET_NAME}"

      - name: Pull Vercel Environment Information
        run: |
          vercel pull --yes \
            --environment=production \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ secrets.VERCEL_ORG_ID }}
        working-directory: projects/${{ matrix.project }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets[steps.secret_name.outputs.name] }}

      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: projects/${{ matrix.project }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets[steps.secret_name.outputs.name] }}

      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "Deployed to: $url"
        working-directory: projects/${{ matrix.project }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets[steps.secret_name.outputs.name] }}

      - name: Comment deployment URL on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ **${{ matrix.project }}** deployed successfully!\n\nâœ¨ Live at: ${{ steps.deploy.outputs.url }}`
            })
