name: Deploy to Vercel

on:
  pull_request:
    types: [closed]
    paths:
      - 'projects/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  detect-changes:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.detect.outputs.projects }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed projects
        id: detect
        run: |
          # Get list of changed files in the PR
          changed_files=$(git diff --name-only HEAD~1 HEAD)

          # Extract unique project directories from changed files
          projects=$(echo "$changed_files" | \
            grep '^projects/' | \
            cut -d'/' -f2 | \
            sort -u | \
            jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "projects=$projects" >> $GITHUB_OUTPUT
          echo "Detected changed projects: $projects"

  deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.projects != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: ${{ fromJSON(needs.detect-changes.outputs.projects) }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Get Vercel Project ID
        id: project_id
        env:
          # Pass all project secrets as env vars
          VERCEL_PROJECT_ID_RADIANT_VELVET_PEAK: ${{ secrets.VERCEL_PROJECT_ID_RADIANT_VELVET_PEAK }}
          VERCEL_PROJECT_ID_COSMIC_SILENT_FOREST: ${{ secrets.VERCEL_PROJECT_ID_COSMIC_SILENT_FOREST }}
          VERCEL_PROJECT_ID_THOUGHT_PARTICLES: ${{ secrets.VERCEL_PROJECT_ID_THOUGHT_PARTICLES }}
          VERCEL_PROJECT_ID_ETHEREAL_AMBER_MEADOW: ${{ secrets.VERCEL_PROJECT_ID_ETHEREAL_AMBER_MEADOW }}
          VERCEL_PROJECT_ID_HIDDEN_CRIMSON_TIDE: ${{ secrets.VERCEL_PROJECT_ID_HIDDEN_CRIMSON_TIDE }}
          VERCEL_PROJECT_ID_LUMINOUS_GENTLE_HORIZON: ${{ secrets.VERCEL_PROJECT_ID_LUMINOUS_GENTLE_HORIZON }}
          VERCEL_PROJECT_ID_MYSTIC_SILVER_CANYON: ${{ secrets.VERCEL_PROJECT_ID_MYSTIC_SILVER_CANYON }}
          VERCEL_PROJECT_ID_VELVET_ELECTRIC_DAWN: ${{ secrets.VERCEL_PROJECT_ID_VELVET_ELECTRIC_DAWN }}
          VERCEL_PROJECT_ID_SERENE_FROZEN_ECHO: ${{ secrets.VERCEL_PROJECT_ID_SERENE_FROZEN_ECHO }}
          VERCEL_PROJECT_ID_BRIGHT_DANCING_RIVER: ${{ secrets.VERCEL_PROJECT_ID_BRIGHT_DANCING_RIVER }}
          VERCEL_PROJECT_ID_TREE_ROCKET_MOUNTAIN: ${{ secrets.VERCEL_PROJECT_ID_TREE_ROCKET_MOUNTAIN }}
        run: |
          # Convert project name to secret format
          SECRET_VAR="VERCEL_PROJECT_ID_$(echo "${{ matrix.project }}" | tr '-' '_' | tr '[:lower:]' '[:upper:]')"
          echo "Looking for secret: $SECRET_VAR"

          # Get the value using bash indirect variable expansion
          PROJECT_ID="${!SECRET_VAR}"

          if [ -z "$PROJECT_ID" ]; then
            echo "Error: Secret $SECRET_VAR not found or is empty"
            exit 1
          fi

          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "Found project ID for ${{ matrix.project }}"

      - name: Pull Vercel Environment Information
        run: |
          vercel pull --yes \
            --environment=production \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ secrets.VERCEL_ORG_ID }}
        working-directory: projects/${{ matrix.project }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ steps.project_id.outputs.project_id }}

      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: projects/${{ matrix.project }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ steps.project_id.outputs.project_id }}

      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "Deployed to: $url"
        working-directory: projects/${{ matrix.project }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ steps.project_id.outputs.project_id }}

      - name: Comment deployment URL on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ **${{ matrix.project }}** deployed successfully!\n\nâœ¨ Live at: ${{ steps.deploy.outputs.url }}`
            })
